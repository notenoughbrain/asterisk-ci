name: Asterisk CI/CD

on:
  push:
    paths:
      - "configs/**"
      - ".github/workflows/**"

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List files (debug)
        run: |
          pwd
          ls -R

      - name: Deploy to STAGE
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGE_HOST }}
          username: ${{ secrets.STAGE_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            BACKUP_DIR=/etc/asterisk-backup-$(date +%Y%m%d%H%M%S)
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp -a "${{ secrets.ASTERISK_CONFIG_PATH }}/." "$BACKUP_DIR/"
            rsync -az --delete configs/ "${{ secrets.STAGE_HOST }}:${{ secrets.ASTERISK_CONFIG_PATH }}/"
            sudo asterisk -rx "core reload" || { echo "Asterisk reload failed"; exit 1; }

      - name: Health check STAGE
        run: |
          echo "Здесь можно повесить curl-запрос или тестовый звонок через API"

      - name: Deploy to PROD
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            BACKUP_DIR=/etc/asterisk-backup-$(date +%Y%m%d%H%M%S)
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp -a "${{ secrets.ASTERISK_CONFIG_PATH }}/." "$BACKUP_DIR/"
            rsync -az --delete configs/ "${{ secrets.PROD_HOST }}:${{ secrets.ASTERISK_CONFIG_PATH }}/"
            sudo asterisk -rx "core reload" || { echo "Asterisk reload failed"; exit 1; }
